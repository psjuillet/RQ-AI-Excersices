<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizational Chart</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Hide OnBase-generated data elements */
        .EmployeeId, .AllEmployees {
            display: none;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        /* Org Chart Container */
        .org-chart {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            height: 100vh;
            justify-content: center;
            gap: 0;
        }

        /* Employee Card Styles */
        .employee-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 7.5px 10px;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Current Employee Highlight */
        .employee-card.current {
            border-color: #007acc;
            background: linear-gradient(135deg, #f0f8ff, white);
        }

        /* Manager Card */
        .employee-card.manager {
            border-color: #28a745;
        }

        /* Direct Report Cards */
        .employee-card.report {
            border-color: #ffc107;
        }

        /* Employee Content Container */
        .employee-content {
            flex: 1;
            text-align: center;
        }

        .employee-name {
            font-weight: bold;
            font-size: 12px;
            color: #333;
            margin-bottom: 5px;
        }

        .employee-title {
            font-size: 10.5px;
            color: #666;
            font-style: italic;
        }

        /* Button Container */
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        /* Contact Button */
        .contact-button {
            background: #007acc;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
        }

        .contact-button .material-icons {
            font-size: 14px;
        }

        .contact-button:hover {
            background: #005a9e;
            transform: scale(1.05);
        }

        .contact-button:active {
            transform: scale(0.95);
        }

        /* Open Button */
        .open-button {
            background: #28a745;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
        }

        .open-button .material-icons {
            font-size: 14px;
        }

        .open-button:hover {
            background: #1e7e34;
            transform: scale(1.05);
        }

        .open-button:active {
            transform: scale(0.95);
        }

        /* Group Button */
        .group-button {
            background: #6c757d;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
        }

        .group-button .material-icons {
            font-size: 14px;
        }

        .group-button:hover {
            background: #5a6268;
            transform: scale(1.05);
        }

        .group-button:active {
            transform: scale(0.95);
        }

        /* Group Count Container */
        .group-count-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Group Count Circle */
        .group-count {
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Additional Employee Details */
        .employee-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .employee-detail {
            font-size: 9px;
            margin: 3px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label {
            font-weight: 500;
            color: #555;
            margin-right: 5px;
        }

        .detail-value {
            color: #777;
            text-align: right;
            flex: 1;
        }

        /* Direct Reports Container */
        .reports-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-content: center;
            width: 100%;
        }

        /* Connection Lines - Hidden in swimlane layout */
        .connection-line {
            display: none;
        }

        /* Swimlane Sections */
        .swimlane {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
            min-height: 120px;
        }

        .swimlane-manager {
            background: rgba(40, 167, 69, 0.08);
            border-left: 4px solid #28a745;
        }

        .swimlane-current {
            background: rgba(0, 122, 204, 0.08);
            border-left: 4px solid #007acc;
        }

        .swimlane-reports {
            background: rgba(255, 193, 7, 0.08);
            border-left: 4px solid #ffc107;
        }

        /* Hierarchy Labels */
        .hierarchy-label {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            width: 120px;
            flex-shrink: 0;
            margin: 0;
        }

        /* Swimlane Content */
        .swimlane-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
        }

        /* Special styling for reports swimlane content */
        .swimlane-reports .swimlane-content {
            align-items: flex-start;
            padding-top: 10px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: #666;
            font-size: 13.5px;
        }

        /* Error State */
        .error {
            text-align: center;
            color: #dc3545;
            font-size: 12px;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        /* Contact Modal */
        .contact-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .contact-modal.show {
            display: flex;
            opacity: 1;
        }

        .contact-card {
            background: white;
            border: 2px solid #007acc;
            border-radius: 12px;
            padding: 20px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .contact-modal.show .contact-card {
            transform: scale(1);
        }

        /* Close button */
        .contact-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: white;
            line-height: 1;
        }

        .contact-close:hover {
            background: #c82333;
        }

        /* Contact Card Header */
        .contact-header {
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .contact-name {
            font-weight: bold;
            font-size: 13.5px;
            color: #333;
            margin-bottom: 5px;
        }

        .contact-title {
            font-size: 10.5px;
            color: #666;
            font-style: italic;
        }

        .contact-department {
            font-size: 9px;
            color: #007acc;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Contact Info Section */
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }

        .contact-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            opacity: 0.7;
        }

        .contact-item-label {
            font-size: 8.25px;
            color: #888;
            text-transform: uppercase;
            font-weight: 500;
            width: 50px;
        }

        .contact-item-value {
            font-size: 9.75px;
            color: #333;
            flex: 1;
        }

        .contact-item-value a {
            color: #007acc;
            text-decoration: none;
        }

        .contact-item-value a:hover {
            text-decoration: underline;
        }

        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100000;
            display: none;
            border: 1px solid #333;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            z-index: 100001;
            font-family: Arial, sans-serif;
        }

        .debug-toggle:hover {
            background: #555;
        }

        .debug-header {
            color: #ffff00;
            font-weight: bold;
            border-bottom: 1px solid #333;
            margin-bottom: 5px;
            padding-bottom: 3px;
        }

        .debug-entry {
            margin: 3px 0;
            padding: 2px 0;
            border-bottom: 1px solid #222;
        }

        .debug-timestamp {
            color: #888;
            font-size: 10px;
        }

        .debug-message {
            color: #00ff00;
            word-wrap: break-word;
        }

        .debug-data {
            color: #ffaa00;
            font-size: 11px;
            margin-left: 10px;
            white-space: pre-wrap;
        }

        .debug-clear {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            margin: 5px 0;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
        }

        .debug-clear:hover {
            background: #c82333;
        }

        /* Add New Employee Button */
        .add-employee-button {
            background: #17a2b8;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
            margin-right: 15px;
        }

        .add-employee-button .material-icons {
            font-size: 18px;
        }

        .add-employee-button:hover {
            background: #138496;
            transform: scale(1.05);
        }

        .add-employee-button:active {
            transform: scale(0.95);
        }

        /* Add Employee Modal */
        .add-employee-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .add-employee-modal.show {
            display: flex;
            opacity: 1;
        }

        .add-employee-card {
            background: white;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 25px;
            min-width: 350px;
            max-width: 450px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .add-employee-modal.show .add-employee-card {
            transform: scale(1);
        }

        .add-employee-header {
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .add-employee-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .add-employee-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .add-employee-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #17a2b8;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
        }

        .modal-button .material-icons {
            font-size: 20px;
        }

        .modal-button:hover {
            transform: scale(1.05);
        }

        .modal-button:active {
            transform: scale(0.95);
        }

        .modal-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .save-button {
            background: #28a745;
        }

        .save-button:hover:not(:disabled) {
            background: #1e7e34;
        }

        .cancel-button {
            background: #dc3545;
        }

        .cancel-button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- OnBase Data Elements (Hidden) -->
    <div class="EmployeeId"><<EmployeeId>></div>
    <table class="AllEmployees">
        <thead>
            <tr>
                <th class="h1">Name</th>
                <th class="h2">EmployeeId</th>
                <th class="h3">Title</th>
                <th class="h4">ReportsToName</th>
                <th class="h5">ReportsToEmployeeId</th>
                <th class="h6">Email</th>
                <th class="h7">Phone</th>
                <th class="h8">Department</th>
                <th class="h9">ObjectId</th>
            </tr>
        </thead>
        <tbody>
<<@~Employee - All>>
            <tr>
                <td class="c1"><<Name>></td>
                <td class="c2"><<EmployeeId>></td>
                <td class="c3"><<Title>></td>
                <td class="c4"><<ReportsTo.Name>></td>
                <td class="c5"><<ReportsTo.EmployeeId>></td>
                <td class="c6"><<Email>></td>
                <td class="c7"><<Phone>></td>
                <td class="c8"><<Department>></td>
                <td class="c9"><<objectid>></td>
            </tr>
<<@End>>
        </tbody>
    </table>

    <!-- Org Chart Display -->
    <div id="orgChart" class="org-chart">
        <div class="loading">Loading organizational chart...</div>
    </div>

    <!-- Debug Panel -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">Debug</button>
    <div id="debugPanel" class="debug-panel">
        <div class="debug-header">
            Debug Console
            <button class="debug-clear" onclick="clearDebugPanel()">Clear</button>
        </div>
        <div id="debugContent"></div>
    </div>

    <script>
        // OnBase WorkView API Constants
        const CLASS_ID = 1257;
        const APPLICATION_NAME = "AI Coding Examples";
        const CLASS_NAME = "Employee";

        // Debug Logger with Visual Panel
        const DEBUG = true; // Set to false to disable debug logging
        let debugPanelVisible = false;
        
        function debugLog(message, data = null) {
            if (DEBUG) {
                // Console logging (if available)
                if (data !== null) {
                    console.log(`[OrgChart Debug] ${message}`, data);
                } else {
                    console.log(`[OrgChart Debug] ${message}`);
                }
                
                // Visual debug panel logging
                addToDebugPanel(message, data);
            }
        }

        function toggleDebugPanel() {
            debugPanelVisible = !debugPanelVisible;
            const panel = document.getElementById('debugPanel');
            if (debugPanelVisible) {
                panel.classList.add('show');
            } else {
                panel.classList.remove('show');
            }
        }

        function clearDebugPanel() {
            document.getElementById('debugContent').innerHTML = '';
        }

        function addToDebugPanel(message, data = null) {
            const debugContent = document.getElementById('debugContent');
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            let html = `<div class="debug-timestamp">[${timestamp}]</div>`;
            html += `<div class="debug-message">${escapeHtml(message)}</div>`;
            
            if (data !== null) {
                html += `<div class="debug-data">${escapeHtml(JSON.stringify(data, null, 2))}</div>`;
            }
            
            entry.innerHTML = html;
            debugContent.appendChild(entry);
            
            // Auto-scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
            
            // Limit number of entries to prevent memory issues
            const entries = debugContent.querySelectorAll('.debug-entry');
            if (entries.length > 50) {
                entries[0].remove();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Get current employee ID
                const currentEmployeeId = document.querySelector('.EmployeeId').textContent.trim();
                
                // Parse table structure dynamically
                const tableData = parseEmployeeTable();
                
                if (!tableData.employees || tableData.employees.length === 0) {
                    throw new Error('No employee data found');
                }

                // Find current employee
                const currentEmployee = tableData.employees.find(emp => emp.employeeId === currentEmployeeId);
                if (!currentEmployee) {
                    throw new Error('Current employee not found in data');
                }

                // Find manager
                const manager = currentEmployee.reportsToEmployeeId ? 
                    tableData.employees.find(emp => emp.employeeId === currentEmployee.reportsToEmployeeId) : null;

                // Find direct reports
                const directReports = tableData.employees.filter(emp => emp.reportsToEmployeeId === currentEmployeeId);

                // Render org chart
                renderOrgChart(manager, currentEmployee, directReports, tableData.availableFields, tableData.employees);

            } catch (error) {
                console.error('Error building org chart:', error);
                document.getElementById('orgChart').innerHTML = 
                    '<div class="error">Error loading organizational chart: ' + error.message + '</div>';
            }
        });

        function parseEmployeeTable() {
            const table = document.querySelector('.AllEmployees');
            if (!table) {
                throw new Error('Employee data table not found');
            }

            // Get column headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => ({
                title: th.textContent.trim(),
                className: th.className
            }));

            // Create field mapping
            const fieldMap = {};
            const availableFields = [];
            
            headers.forEach((header, index) => {
                const fieldName = normalizeFieldName(header.title);
                fieldMap[index] = fieldName;
                availableFields.push({
                    name: fieldName,
                    title: header.title,
                    index: index
                });
            });

            // Parse employee data
            const employees = [];
            const tableRows = table.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= headers.length) {
                    const employee = {};
                    
                    cells.forEach((cell, index) => {
                        const fieldName = fieldMap[index];
                        if (fieldName) {
                            employee[fieldName] = cell.textContent.trim();
                        }
                    });
                    
                    // Validate required fields
                    if (employee.name && employee.employeeId) {
                        employees.push(employee);
                    }
                }
            });

            return {
                employees: employees,
                availableFields: availableFields,
                fieldMap: fieldMap
            };
        }

        function normalizeFieldName(headerText) {
            // Map common header variations to standard field names
            const fieldMapping = {
                'name': 'name',
                'employeeid': 'employeeId',
                'title': 'title',
                'reportstoname': 'reportsToName',
                'reportstoemployeeid': 'reportsToEmployeeId',
                'department': 'department',
                'email': 'email',
                'phone': 'phone',
                'location': 'location',
                'objectid': 'objectId'
            };

            const normalized = headerText.toLowerCase().replace(/[^a-z0-9]/g, '');
            return fieldMapping[normalized] || normalized;
        }

        function createEmployeeCard(employee, type = '', availableFields = [], currentEmployeeId = null, allEmployees = []) {
            const card = document.createElement('div');
            card.className = `employee-card ${type}`;
            
            // Create employee content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'employee-content';
            
            // Create employee name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'employee-name';
            nameDiv.textContent = employee.name || 'Unknown';
            
            // Create title div
            const titleDiv = document.createElement('div');
            titleDiv.className = 'employee-title';
            titleDiv.textContent = employee.title || 'No Title';
            
            // Append name and title to content
            contentDiv.appendChild(nameDiv);
            contentDiv.appendChild(titleDiv);
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            
            // Create contact button
            const contactButton = document.createElement('button');
            contactButton.className = 'contact-button';
            contactButton.innerHTML = '<span class="material-icons">contact_mail</span>';
            contactButton.title = 'View Contact Info';
            contactButton.addEventListener('click', () => showContactModal(employee, availableFields));
            buttonContainer.appendChild(contactButton);
            
            // Create open button (only for non-current employees)
            if (employee.employeeId !== currentEmployeeId) {
                const openButton = document.createElement('button');
                openButton.className = 'open-button';
                openButton.innerHTML = '<span class="material-icons">open_in_browser</span>';
                openButton.title = 'Open Employee Record';
                openButton.addEventListener('click', () => openEmployeeRecord(employee.objectId));
                buttonContainer.appendChild(openButton);
            }

            // Check if employee has direct reports
            const directReportsCount = allEmployees.filter(emp => emp.reportsToEmployeeId === employee.employeeId).length;
            
            if (directReportsCount > 0) {
                // Create group button and count container
                const groupCountContainer = document.createElement('div');
                groupCountContainer.className = 'group-count-container';
                
                // Create group button
                const groupButton = document.createElement('button');
                groupButton.className = 'group-button';
                groupButton.innerHTML = '<span class="material-icons">group</span>';
                groupButton.title = `Has ${directReportsCount} Direct Report${directReportsCount === 1 ? '' : 's'}`;
                
                // Create count circle
                const countCircle = document.createElement('div');
                countCircle.className = 'group-count';
                countCircle.textContent = directReportsCount;
                countCircle.title = `${directReportsCount} Direct Report${directReportsCount === 1 ? '' : 's'}`;
                
                groupCountContainer.appendChild(groupButton);
                groupCountContainer.appendChild(countCircle);
                buttonContainer.appendChild(groupCountContainer);
            }
            
            // Append content and buttons to card
            card.appendChild(contentDiv);
            card.appendChild(buttonContainer);

            // Add additional fields if available (excluding contact info shown in modal and internal fields)
            const additionalFields = availableFields.filter(field => 
                !['name', 'employeeid', 'title', 'reportstoname', 'reportstoemployeeid', 'email', 'phone', 'department', 'objectid'].includes(field.name.toLowerCase()) &&
                employee[field.name] && employee[field.name].trim()
            );

            if (additionalFields.length > 0) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'employee-details';
                
                additionalFields.forEach(field => {
                    const value = employee[field.name];
                    if (value && value.trim()) {
                        const detailDiv = document.createElement('div');
                        detailDiv.className = 'employee-detail';
                        detailDiv.innerHTML = `
                            <span class="detail-label">${field.title}:</span>
                            <span class="detail-value">${value}</span>
                        `;
                        detailsDiv.appendChild(detailDiv);
                    }
                });
                
                contentDiv.appendChild(detailsDiv);
            }
            
            return card;
        }

        function showContactModal(employee, availableFields = []) {
            // Remove any existing modal
            const existingModal = document.querySelector('.contact-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'contact-modal';
            
            // Create contact card
            const contactCard = createContactCard(employee, availableFields);
            
            // Create close button
            const closeButton = document.createElement('button');
            closeButton.className = 'contact-close';
            closeButton.innerHTML = 'Ã—';
            closeButton.addEventListener('click', hideContactModal);
            
            contactCard.appendChild(closeButton);
            modal.appendChild(contactCard);
            
            // Add to body
            document.body.appendChild(modal);
            
            // Show modal with animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideContactModal();
                }
            });
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    hideContactModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function hideContactModal() {
            const modal = document.querySelector('.contact-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function createContactCard(employee, availableFields = []) {
            const contactCard = document.createElement('div');
            contactCard.className = 'contact-card';
            
            // Contact header
            const header = document.createElement('div');
            header.className = 'contact-header';
            
            const contactName = document.createElement('div');
            contactName.className = 'contact-name';
            contactName.textContent = employee.name || 'Unknown';
            
            const contactTitle = document.createElement('div');
            contactTitle.className = 'contact-title';
            contactTitle.textContent = employee.title || 'No Title';
            
            header.appendChild(contactName);
            header.appendChild(contactTitle);
            
            // Add department if available
            if (employee.department && employee.department.trim()) {
                const contactDept = document.createElement('div');
                contactDept.className = 'contact-department';
                contactDept.textContent = employee.department;
                header.appendChild(contactDept);
            }
            
            // Contact info section
            const contactInfo = document.createElement('div');
            contactInfo.className = 'contact-info';
            
            // Add email if available
            if (employee.email && employee.email.trim()) {
                const emailItem = createContactItem('EMAIL', employee.email, `mailto:${employee.email}`, 'ðŸ“§');
                contactInfo.appendChild(emailItem);
            }
            
            // Add phone if available
            if (employee.phone && employee.phone.trim()) {
                const phoneItem = createContactItem('PHONE', employee.phone, `tel:${employee.phone}`, 'ðŸ“ž');
                contactInfo.appendChild(phoneItem);
            }
            
            // Add employee ID
            if (employee.employeeId && employee.employeeId.trim()) {
                const idItem = createContactItem('ID', employee.employeeId, null, 'ðŸ†”');
                contactInfo.appendChild(idItem);
            }
            
            // Add other available contact fields
            const contactFields = availableFields.filter(field => 
                ['location', 'office', 'extension'].includes(field.name.toLowerCase()) &&
                employee[field.name] && employee[field.name].trim()
            );
            
            contactFields.forEach(field => {
                const icon = getContactIcon(field.name.toLowerCase());
                const item = createContactItem(field.title.toUpperCase(), employee[field.name], null, icon);
                contactInfo.appendChild(item);
            });
            
            contactCard.appendChild(header);
            contactCard.appendChild(contactInfo);
            
            return contactCard;
        }
        
        function createContactItem(label, value, link = null, icon = 'ðŸ“„') {
            const item = document.createElement('div');
            item.className = 'contact-item';
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'contact-icon';
            iconSpan.textContent = icon;
            
            const labelSpan = document.createElement('span');
            labelSpan.className = 'contact-item-label';
            labelSpan.textContent = label;
            
            const valueSpan = document.createElement('span');
            valueSpan.className = 'contact-item-value';
            
            if (link) {
                const linkEl = document.createElement('a');
                linkEl.href = link;
                linkEl.textContent = value;
                valueSpan.appendChild(linkEl);
            } else {
                valueSpan.textContent = value;
            }
            
            item.appendChild(iconSpan);
            item.appendChild(labelSpan);
            item.appendChild(valueSpan);
            
            return item;
        }
        
        function getContactIcon(fieldName) {
            const iconMap = {
                'location': 'ðŸ“',
                'office': 'ðŸ¢',
                'extension': 'â˜Žï¸',
                'mobile': 'ðŸ“±',
                'fax': 'ðŸ“ '
            };
            return iconMap[fieldName] || 'ðŸ“„';
        }

        function openEmployeeRecord(objectId) {
            try {
                debugLog(`Opening employee record for ObjectId: ${objectId}`);
                debugLog('Environment detection:', {
                    'User Agent': navigator.userAgent,
                    'Is Embedded': window.parent !== window,
                    'Window location': window.location.href,
                    'Document domain': document.domain
                });
                
                // Enhanced API availability check
                debugLog('API Availability Check:', {
                    'window.$WVAPI exists': typeof window.$WVAPI !== 'undefined',
                    'global $WVAPI exists': typeof $WVAPI !== 'undefined',
                    '$WVAPI type': typeof $WVAPI,
                    '$WVAPI object keys': typeof $WVAPI === 'object' ? Object.keys($WVAPI || {}) : 'N/A',
                    'DisplayObject method type': typeof $WVAPI !== 'undefined' ? typeof $WVAPI.DisplayObject : 'N/A'
                });
                
                // Try multiple API access patterns
                let wvapi = null;
                let apiSource = '';
                
                if (typeof $WVAPI !== 'undefined' && $WVAPI) {
                    wvapi = $WVAPI;
                    apiSource = 'global $WVAPI';
                } else if (typeof window.$WVAPI !== 'undefined' && window.$WVAPI) {
                    wvapi = window.$WVAPI;
                    apiSource = 'window.$WVAPI';
                } else if (typeof parent.$WVAPI !== 'undefined' && parent.$WVAPI) {
                    wvapi = parent.$WVAPI;
                    apiSource = 'parent.$WVAPI';
                } else if (typeof top.$WVAPI !== 'undefined' && top.$WVAPI) {
                    wvapi = top.$WVAPI;
                    apiSource = 'top.$WVAPI';
                }
                
                debugLog(`API Source: ${apiSource}`, { wvapi: wvapi });
                
                // Call OnBase WorkView API to display employee object
                if (wvapi && typeof wvapi.DisplayObject === 'function') {
                    const displayParams = {
                        classId: String(CLASS_ID),
                        objectId: String(objectId)
                    };
                    
                    debugLog(`Calling DisplayObject via ${apiSource}:`, displayParams);
                    debugLog('Parameter types:', {
                        'classId type': typeof displayParams.classId,
                        'objectId type': typeof displayParams.objectId,
                        'classId value': displayParams.classId,
                        'objectId value': displayParams.objectId
                    });
                    
                    wvapi.DisplayObject(displayParams);
                    debugLog('DisplayObject method called successfully');
                } else {
                    const errorInfo = {
                        'API Source': apiSource || 'None found',
                        'wvapi exists': !!wvapi,
                        'DisplayObject exists': wvapi ? typeof wvapi.DisplayObject : 'N/A',
                        'Available methods': wvapi ? Object.keys(wvapi).filter(key => typeof wvapi[key] === 'function') : 'N/A'
                    };
                    
                    debugLog('OnBase WorkView API not available', errorInfo);
                    console.error('OnBase WorkView API not available', errorInfo);
                    alert(`Unable to open employee record. OnBase WorkView API not available.\n\nDebug Info:\n${JSON.stringify(errorInfo, null, 2)}`);
                }
            } catch (error) {
                debugLog('Error in openEmployeeRecord:', {
                    error: error,
                    message: error.message,
                    stack: error.stack,
                    objectId: objectId
                });
                console.error('Error opening employee record:', error);
                alert(`Error opening employee record: ${error.message}\n\nCheck browser console for details.`);
            }
        }

        function showAddEmployeeModal(managerEmployee) {
            debugLog('showAddEmployeeModal called', { managerEmployee: managerEmployee });
            
            // Remove any existing modal
            const existingModal = document.querySelector('.add-employee-modal');
            if (existingModal) {
                debugLog('Removing existing modal');
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'add-employee-modal';
            
            // Create add employee card
            const addEmployeeCard = document.createElement('div');
            addEmployeeCard.className = 'add-employee-card';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'add-employee-header';
            
            const title = document.createElement('h3');
            title.className = 'add-employee-title';
            title.textContent = 'Add New Direct Report';
            
            const subtitle = document.createElement('div');
            subtitle.className = 'add-employee-subtitle';
            subtitle.textContent = `New employee will report to: ${managerEmployee.name}`;
            
            header.appendChild(title);
            header.appendChild(subtitle);
            
            // Create form
            const form = document.createElement('form');
            form.className = 'add-employee-form';
            
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.textContent = 'Employee Name *';
            label.setAttribute('for', 'employeeName');
            
            const input = document.createElement('input');
            input.className = 'form-input';
            input.type = 'text';
            input.id = 'employeeName';
            input.name = 'employeeName';
            input.placeholder = 'Enter full name (e.g., John Smith)';
            input.required = true;
            
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            form.appendChild(formGroup);
            
            // Create buttons - ADD THEM TO THE FORM
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'modal-buttons';
            
            const saveButton = document.createElement('button');
            saveButton.className = 'modal-button save-button';
            saveButton.type = 'submit';
            saveButton.innerHTML = '<span class="material-icons">save</span>';
            saveButton.title = 'Save New Employee';
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'modal-button cancel-button';
            cancelButton.type = 'button';
            cancelButton.innerHTML = '<span class="material-icons">cancel</span>';
            cancelButton.title = 'Cancel';
            cancelButton.addEventListener('click', hideAddEmployeeModal);
            
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
            
            // Add buttons to form, not to card
            form.appendChild(buttonContainer);
            
            // Assemble modal
            addEmployeeCard.appendChild(header);
            addEmployeeCard.appendChild(form);
            modal.appendChild(addEmployeeCard);
            
            // Add to body
            document.body.appendChild(modal);
            
            // Add event listeners after DOM assembly
            debugLog('Adding form submit event listener to form:', form);
            debugLog('Save button is in form:', form.contains(saveButton));
            
            form.addEventListener('submit', (e) => {
                debugLog('*** FORM SUBMISSION EVENT TRIGGERED ***');
                e.preventDefault();
                const employeeName = input.value.trim();
                debugLog('Employee name from input:', employeeName);
                debugLog('Manager object ID:', managerEmployee.objectId);
                
                if (employeeName) {
                    debugLog('Employee name validation passed, proceeding with save');
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="material-icons">hourglass_empty</span>';
                    createNewEmployee(employeeName, managerEmployee.objectId);
                } else {
                    debugLog('Employee name validation failed - empty name');
                }
            });
            
            // Add click handler for additional debugging
            saveButton.addEventListener('click', (e) => {
                debugLog('Save button clicked - event details:', {
                    'button type': saveButton.type,
                    'input value': input.value,
                    'form contains button': form.contains(saveButton),
                    'button form property': saveButton.form,
                    'event default prevented': e.defaultPrevented
                });
            });

            // Show modal with animation
            setTimeout(() => {
                debugLog('Showing modal and focusing input');
                modal.classList.add('show');
                input.focus();
            }, 10);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideAddEmployeeModal();
                }
            });
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    hideAddEmployeeModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function hideAddEmployeeModal() {
            const modal = document.querySelector('.add-employee-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function createNewEmployee(employeeName, managerObjectId) {
            try {
                debugLog(`Creating new employee: ${employeeName} reporting to ObjectId: ${managerObjectId}`);
                
                // Try multiple API access patterns
                let wvapi = null;
                let apiSource = '';
                
                if (typeof $WVAPI !== 'undefined' && $WVAPI) {
                    wvapi = $WVAPI;
                    apiSource = 'global $WVAPI';
                } else if (typeof window.$WVAPI !== 'undefined' && window.$WVAPI) {
                    wvapi = window.$WVAPI;
                    apiSource = 'window.$WVAPI';
                } else if (typeof parent.$WVAPI !== 'undefined' && parent.$WVAPI) {
                    wvapi = parent.$WVAPI;
                    apiSource = 'parent.$WVAPI';
                } else if (typeof top.$WVAPI !== 'undefined' && top.$WVAPI) {
                    wvapi = top.$WVAPI;
                    apiSource = 'top.$WVAPI';
                }
                
                debugLog(`API Source for CreateObject: ${apiSource}`, { wvapi: wvapi });
                
                if (wvapi && typeof wvapi.CreateObject === 'function') {
                    // Create values object with correct OnBase format
                    const valuesObject = {
                        Name: employeeName,
                        ReportsTo: String(managerObjectId)
                    };
                    
                    const createParams = {
                        applicationName: String(APPLICATION_NAME),
                        className: String(CLASS_NAME),
                        status: "active",
                        values: valuesObject
                    };
                    
                    debugLog(`Calling CreateObject via ${apiSource}:`, createParams);
                    debugLog('Parameter types:', {
                        'applicationName type': typeof createParams.applicationName,
                        'className type': typeof createParams.className,
                        'status type': typeof createParams.status,
                        'values type': typeof createParams.values,
                        'values content': createParams.values
                    });
                    
                    // Call CreateObject with success callback
                    wvapi.CreateObject(createParams, function(result) {
                        debugLog('CreateObject SUCCESS callback triggered', result);
                        debugLog('Created object details:', {
                            'result type': typeof result,
                            'result value': result,
                            'employee name': employeeName,
                            'manager objectId': managerObjectId
                        });
                        
                        // Hide modal after successful creation
                        hideAddEmployeeModal();
                        
                        // Show success message with result details
                        const successMessage = `Success! Employee "${employeeName}" has been created successfully.\n\nNew employee will appear after refreshing the page.`;
                        alert(successMessage);
                        
                        // Optional: Auto-refresh after a short delay
                        // setTimeout(() => {
                        //     window.location.reload();
                        // }, 2000);
                    });
                    
                    debugLog('CreateObject method called successfully');
                    
                } else {
                    const errorInfo = {
                        'API Source': apiSource || 'None found',
                        'wvapi exists': !!wvapi,
                        'CreateObject exists': wvapi ? typeof wvapi.CreateObject : 'N/A',
                        'Available methods': wvapi ? Object.keys(wvapi).filter(key => typeof wvapi[key] === 'function') : 'N/A'
                    };
                    
                    debugLog('OnBase WorkView CreateObject API not available', errorInfo);
                    console.error('OnBase WorkView CreateObject API not available', errorInfo);
                    alert(`Unable to create new employee. OnBase WorkView CreateObject API not available.\n\nDebug Info:\n${JSON.stringify(errorInfo, null, 2)}`);
                    
                    // Re-enable save button
                    const saveButton = document.querySelector('.save-button');
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = '<span class="material-icons">save</span>';
                    }
                }
            } catch (error) {
                debugLog('Error in createNewEmployee:', {
                    error: error,
                    message: error.message,
                    stack: error.stack,
                    employeeName: employeeName,
                    managerObjectId: managerObjectId
                });
                console.error('Error creating new employee:', error);
                alert(`Error creating new employee: ${error.message}\n\nCheck browser console for details.`);
                
                // Re-enable save button
                const saveButton = document.querySelector('.save-button');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<span class="material-icons">save</span>';
                }
            }
        }

        function createConnectionLine() {
            const line = document.createElement('div');
            line.className = 'connection-line';
            return line;
        }

        function renderOrgChart(manager, currentEmployee, directReports, availableFields = [], allEmployees = []) {
            const orgChart = document.getElementById('orgChart');
            orgChart.innerHTML = '';

            // Manager swimlane section
            if (manager) {
                const managerSwimlane = document.createElement('div');
                managerSwimlane.className = 'swimlane swimlane-manager';
                
                const managerLabel = document.createElement('div');
                managerLabel.className = 'hierarchy-label';
                managerLabel.textContent = 'Reports To';
                
                const managerContent = document.createElement('div');
                managerContent.className = 'swimlane-content';
                managerContent.appendChild(createEmployeeCard(manager, 'manager', availableFields, currentEmployee.employeeId, allEmployees));
                
                managerSwimlane.appendChild(managerLabel);
                managerSwimlane.appendChild(managerContent);
                orgChart.appendChild(managerSwimlane);
            }

            // Current employee swimlane section
            const currentSwimlane = document.createElement('div');
            currentSwimlane.className = 'swimlane swimlane-current';
            
            const currentLabel = document.createElement('div');
            currentLabel.className = 'hierarchy-label';
            currentLabel.textContent = 'Current Employee';
            
            const currentContent = document.createElement('div');
            currentContent.className = 'swimlane-content';
            currentContent.appendChild(createEmployeeCard(currentEmployee, 'current', availableFields, currentEmployee.employeeId, allEmployees));
            
            currentSwimlane.appendChild(currentLabel);
            currentSwimlane.appendChild(currentContent);
            orgChart.appendChild(currentSwimlane);

            // Direct reports swimlane section
            const reportsSwimlane = document.createElement('div');
            reportsSwimlane.className = 'swimlane swimlane-reports';
            
            const reportsLabel = document.createElement('div');
            reportsLabel.className = 'hierarchy-label';
            reportsLabel.textContent = `Direct Reports (${directReports.length})`;
            
            const reportsContent = document.createElement('div');
            reportsContent.className = 'swimlane-content';
            
            // Create add employee button
            const addButton = document.createElement('button');
            addButton.className = 'add-employee-button';
            addButton.innerHTML = '<span class="material-icons">group_add</span>';
            addButton.title = 'Add New Direct Report';
            addButton.addEventListener('click', () => {
                debugLog('Add employee button clicked');
                showAddEmployeeModal(currentEmployee);
            });
            
            const reportsContainer = document.createElement('div');
            reportsContainer.className = 'reports-container';

            directReports.forEach(report => {
                reportsContainer.appendChild(createEmployeeCard(report, 'report', availableFields, currentEmployee.employeeId, allEmployees));
            });
            
            reportsContent.appendChild(addButton);
            reportsContent.appendChild(reportsContainer);
            reportsSwimlane.appendChild(reportsLabel);
            reportsSwimlane.appendChild(reportsContent);
            orgChart.appendChild(reportsSwimlane);
        }
    </script>
</body>
</html>